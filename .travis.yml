language: haskell

matrix:
  include:
    - env: GHC=7.8.4  LLVM=3.4                          # will use system installs of both
      addons:
        apt:
          sources:
            - hvr-ghc
          packages:
            - happy-1.19.5
            - alex-3.1.4
            - cabal-install-1.22

    - env: GHC=7.10.1 LLVM=3.5
      addons:
        apt:
          sources:
            - hvr-ghc
            - llvm-toolchain-precise-3.5
            - ubuntu-toolchain-r-test
          packages:
            - happy-1.19.5
            - alex-3.1.4
            - cabal-install-1.22
            - ghc-7.10.1
            - llvm-3.5

cache:
  directories:
    - $HOME/.ghc
    - $HOME/.cabal/bin
    - $HOME/.cabal/lib
    - $HOME/.cabal/share

before_install:
    - export PATH=/opt/alex/3.1.4/bin:${PATH}
    - export PATH=/opt/happy/1.19.5/bin:${PATH}
    - export PATH=/opt/cabal/1.22/bin:${PATH}
    - export PATH=/opt/ghc/${GHC}/bin:${PATH}           # hvr-installed versions
    - export PATH=/usr/local/ghc/${GHC}/bin:${PATH}     # system installed versions
    - export PATH=/usr/lib/llvm-${LLVM}/bin:${PATH}

install:
    - which -a cabal
    - which -a ghc
    - which -a opt
    - which -a llc
    - which -a alex
    - which -a happy
    - echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo '?')]"
    - cabal --version
    - alex --version
    - happy --version
    - opt --version; true
    - llc --version; true

    # Install and upgrade the dependencies. Since we cache the cabal directory,
    # if there are any problems throw it away and try again.
    #
    - travis_retry if [ ! $( cabal install --only-dependencies --upgrade-dependencies --enable-tests ${MODE} ) ]; then \
          rm -rf $HOME/.ghc; \
          rm -rf $HOME/.cabal/bin; \
          rm -rf $HOME/.cabal/lib; \
          rm -rf $HOME/.cabal/share; \
          cabal update; \
          ghc-pkg recache --user; \
        fi

script:
    - cabal install
    - travis-test

